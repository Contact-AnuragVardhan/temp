var NSScroller = (function()
{
	function NSScroller(setting)
	{
		var self = this;
		var util = null;
		var config = {};
		
		var parentNode = null;
		var divScrollBarCorner = null;
		
		var props = {
			    vertical: {
			        x: 'Y',direction:'v', pos: 'top', 
			        size: 'height',crossSize: 'width', crossMinSize: 'min-width', crossMaxSize: 'max-width',
			        client: 'clientHeight', crossClient: 'clientWidth',
			        scrollEdge: 'scrollLeft',offset: 'offsetHeight', crossOffset: 'offsetWidth', offsetPos: 'offsetTop',
			        scroll: 'scrollTop', scrollSize: 'scrollHeight',barTopLimit:0,containerCSS:"nsScrollerVerticalContainer",
			        scrollerCSS:"nsScrollerVerticalBar",buttonProp:"verticalScrollButtons",beforeButtonProp:"topHTML",
			        afterButtonProp:"bottomHTML",beforeButtonCSS:"nsScrollerButtonUp",afterButtonCSS:"nsScrollerButtonDown",
			        elementPosition:config.elementPosition
			    },
			    horizontal: {
			        x: 'X',direction:'h', pos: 'left',
			        size: 'width',crossSize: 'height', crossMinSize: 'min-height', crossMaxSize: 'max-height',
			        client: 'clientWidth', crossClient: 'clientHeight',
			        scrollEdge: 'scrollTop',offset: 'offsetWidth', crossOffset: 'offsetHeight', offsetPos: 'offsetLeft',
			        scroll: 'scrollLeft', scrollSize: 'scrollWidth',barTopLimit:0,containerCSS:"nsScrollerHorizontal",
			        scrollerCSS:"nsScrollerHorizontalBar",buttonProp:"horizontalScrollButtons",beforeButtonProp:"leftHTML",
			        afterButtonProp:"rightHTML",beforeButtonCSS:"nsScrollerButtonLeft",afterButtonCSS:"nsScrollerButtonRight",
			        elementPosition:config.elementPosition
			    }
		};
		
		var operaMaxScrollBarSize = 17;
		var macScrollBarSize = 15;
		var macFFRegex = /[\s\S]*Macintosh[\s\S]*\) Gecko[\s\S]*/;
		var isMacFF = macFFRegex.test(window.navigator && window.navigator.userAgent);
		
		var selectedItem = null;
		var interval = null;
		var delayInterval = null;
		var mutationObserver = null;
		
		var documentMouseMoveRef = null;
		var documentMouseUpRef = null;
		var documentTouchMoveRef = null;
		var documentTouchEndRef = null;
		
		var initialize = function()
		{
			util = new NSUtil();
			if(!setting)
			{
				setting = {};
			}
			config = {
				element : setting["element"],
				scrollableElement : setting["scrollableElement"],
				otherScrollableElement : setting["otherScrollableElement"],//for Grid if we have left,center and right body
				horizontalScrollButtons: setting["horizontalScrollButtons"] || {enable:false,leftHTML:null,rightHTML:null},
				verticalScrollButtons: setting["verticalScrollButtons"] || {enable:false,topHTML:null,bottomHTML:null},
				elementPosition: setting["elementPosition"] || "relative" // if content has fixable headers then use static (values: static,relative,absolute)
			};
			if(!config.scrollableElement)
			{
				util.throwNSError("NSScroller","ScrollableElement in setting is missing");
			}
			if(!config.element)
			{
				config.element = config.scrollableElement.parentNode;
			}
			parentNode = config.scrollableElement.parentNode;
			if(config.horizontalScrollButtons.enable)
			{
				if(!config.horizontalScrollButtons.leftHTML)
				{
					config.horizontalScrollButtons.leftHTML = '&#9668;';
				}
				if(!config.horizontalScrollButtons.rightHTML)
				{
					config.horizontalScrollButtons.rightHTML = '&#9658;';
				}
			}
			if(config.verticalScrollButtons.enable)
			{
				if(!config.verticalScrollButtons.topHTML)
				{
					config.verticalScrollButtons.topHTML = '&#9650;';
				}
				if(!config.verticalScrollButtons.bottomHTML)
				{
					config.verticalScrollButtons.bottomHTML = '&#9660;';
				}
			}
			util.addStyleClass(config.scrollableElement,"nsScrollerScrollable");
			createComponent();
			util.addEvent(config.scrollableElement,"mousewheel",mouseWheelHandler);
			util.addEvent(config.scrollableElement,"scroll",bodyScrollHandler);
			if(config.otherScrollableElement && config.otherScrollableElement.length > 0)
			{
				for(var count = 0;count < config.otherScrollableElement.length;count++)
				{
					var element = config.otherScrollableElement[count];
					util.addEvent(element,"mousewheel",mouseWheelHandler);
				}
			}
			util.addStyleClass(config.element,"nsScrollerElement");
			updateScrollBars();
			util.addEvent(window,"resize",updateWithDelay);
			addObserver();
		};
		
		var applyStyle = function(item,on) 
		{
	        var overflow = on ? 'hidden' : null;
	        var msOverflowStyle = on ? 'none' : null;
	
	        util.css(parentNode, {
	            overflow: overflow,
	            msOverflowStyle: msOverflowStyle,
	            position: item.elementPosition == 'static' ? '' : 'relative'
	        });
	
	        var scroll = on ? 'scroll' : null;
	        var axis = item.direction == 'v' ? 'y' : 'x';
	        var css = {};
	
	        css['overflow-' + axis] = scroll;
	        css['box-sizing'] = 'border-box';
	        css.margin = '0';
	        css.border = '0';
	
	        if (item.elementPosition == 'absolute') 
	        {
	        	css.position = 'absolute';
	        	css.top = '0';
	
	            if (item.direction == 'h') 
	            {
	            	css.left = scrollerCss.right = '0';
	            } 
	            else 
	            {
	            	css.bottom = '0';
	            	css.right = item.rtl ? '0' : '';
	            	css.left = item.rtl ? '' : '0';
	            }
	        }
	        util.css(config.scrollableElement,css);
	    };
	    
	    var onScrollerContainerMouseDown = function(event) 
		{
	    	event = util.getEvent(event);
	    	var target = null;
			if(util.hasStyleClass(event.target,"nsScrollerBarParent"))
			{
				target = event.target.querySelector(".nsScrollerBar");
			}
			setSelectedItem(event,target);
			if(selectedItem)
			{
				var scroller = selectedItem.scroller;
				var offsetX = event["offset" + selectedItem.x];
				var xBar = scroller[selectedItem.offsetPos];
	            var moveOffset = 0;
	            if (offsetX < xBar) 
	            {
	            	moveOffset = -1;
	            } 
	            else if (offsetX > xBar + scroller[selectedItem.offset]) 
	            {
	            	moveOffset = 1;
	            }
	            var y = scrollableElementPosition(selectedItem) + moveOffset * 0.9 * config.scrollableElement[selectedItem.client];
	            scrollableElementPosition(selectedItem,y);
			}
		};
		
		var onScrollerMouseDown = function(event) 
		{
			event = util.getEvent(event);
			setSelectedItem(event);
			if(selectedItem)
			{
				addDocumentHandler(docMouseMoveHandler,docMouseUpHandler);
			    event.preventDefault();
			    event.stopPropagation();
			    selection(false);
			    if(selectedItem.activeCSS)
			    {
			    	util.addStyleClass(selectedItem.scroller,selectedItem.activeCSS);
			    }
			}
		};
		
		var setSelectedItem = function(event,target)
		{
			target = target ? target : event.target
			selectedItem = getItemByScroller(target);
			if(selectedItem)
			{
				selectedItem.dragging = true;
				selectedItem.scrollerPos = getCursorPosition(selectedItem,event) - selectedItem.barPos;
			}
		};
		
		var getItemByScroller = function(scroller)
		{
			for(var key in props)
			{
				var item = props[key];
				if(item.scroller == scroller)
				{
					return item;
				}
			}
			
			return null;
		};
		
		var selection = function(enable)
		{
			if(enable)
			{
				util.removeEvent(document,"selectpos",disableSelectionHandler);
				util.removeEvent(document,"selectstart",disableSelectionHandler);
			}
			else
			{
				util.addEvent(document,"selectpos",disableSelectionHandler);
				util.addEvent(document,"selectstart",disableSelectionHandler);				
			}
		};
		
		var disableSelectionHandler = function(event)
		{
			event = util.getEvent(event);
			event.preventDefault();
		};
		
		var createComponent = function()
		{
			for(var key in props)
			{
				var item = props[key];
				var container = createScroller(null,item.containerCSS,item.scrollerCSS);
				var scroller = container.children[0];
				var eleBefore = null;
				var eleAfter = null;
				var scrollerParent = container;
				if(config[item.buttonProp]["enable"])
				{
					var eleBefore = createButton(item,item.beforeButtonCSS,config[item.buttonProp][item.beforeButtonProp]);
					container.appendChild(eleBefore);
					scrollerParent = util.createDiv(null,"nsScrollerBarParent-" + item.direction);
					scrollerParent.appendChild(scroller);
					container.appendChild(scrollerParent);
					var eleAfter = createButton(item,item.afterButtonCSS,config[item.buttonProp][item.afterButtonProp]);
					container.appendChild(eleAfter);
					item.buttonBefore = eleBefore;
					item.buttonAfter = eleAfter;
				}
				util.addStyleClass(scrollerParent,"nsScrollerBarParent");
				config.element.appendChild(container);
				container.style[item.crossSize] = scroller[item.crossOffset] + "px";
				util.addEvent(scrollerParent,"mousedown",onScrollerContainerMouseDown);
				util.addEvent(scroller,"mousedown",onScrollerMouseDown);
				item.scrollContainer = container;
				item.container = scrollerParent;
				item.scroller = scroller;
			}
			divScrollBarCorner = util.createDiv(null,"nsScrollBarCorner");
			config.element.appendChild(divScrollBarCorner);
		};
		
		var createScroller = function(id,cssContainer,cssScroller)
		{
			cssContainer = cssContainer ? cssContainer : "";
			cssScroller = cssScroller ? cssScroller : "";
			var scrollContainer = util.createDiv(null,"nsScrollerContainer " + cssContainer);
			var scroller = util.createDiv(null,"nsScrollerBar " + cssScroller);
			scrollContainer.appendChild(scroller);
			return scrollContainer;
		};
		
		var createButton = function(item,css,html)
		{
			var div = util.createDiv(null,"nsScrollerControl nsScrollerControl-" + item.direction);
			div.innerHTML = html;
			util.addStyleClass(div,css);
			//util.addEvent(div,"click",btnControlClickHandler);
			util.addEvent(div,"mousedown",btnMouseDownHandler);
			util.addEvent(div,"dblclick",btnMouseDownHandler);
			util.addEvent(div,"mouseup",clearScroll);
			util.addEvent(div,"mouseout",clearScroll);
			return div;
		};
		
		var btnMouseDownHandler = function(event)
		{
			btnControlClickHandler(event);
			interval = setTimeout(function(){btnMouseDownHandler(event);}, 100);
		};
		
		var clearScroll = function(event)
		{
			clearTimeout(interval);
			interval = null;
		};
		
		var btnControlClickHandler = function(event)
		{
			event = util.getEvent(event);
			var target = event.target;
			var parent = target.parentNode;
			var scroller = parent.querySelector(".nsScrollerBar");
			setSelectedItem(event,scroller);
			if(selectedItem)
			{
				var isAdd = true;
				if(util.hasStyleClass(target,selectedItem.beforeButtonCSS))
				{
					isAdd = false;
				}
				var oldPos = scrollableElementPosition(selectedItem);
				var newPos = isAdd ? (oldPos + 30) : (oldPos - 30);
				scrollableElementPosition(selectedItem,newPos);
				//selectedItem = null;
				event.preventDefault();
				event.stopPropagation();
			}
		};
		
		var mouseWheelHandler = function(event)
		{
			
		};
		
		var bodyScrollHandler = function(event)
		{
			event = util.getEvent(event);
			if(!selectedItem)
			{
				var element = config.element;
				var verticalScroller = element.querySelector(".nsScrollerVerticalBar");
				setSelectedItem(event,verticalScroller);
			}
			scrollBody(selectedItem,event);
		};
		
		var docMouseMoveHandler = function(event)
		{
			event = util.getEvent(event);
	        if(selectedItem && selectedItem.dragging)
	        {
	        	dragHandler(selectedItem,event);
	        }
		};
		
		var docMouseUpHandler = function(event)
		{
			event = util.getEvent(event);
			removeDocumentHandler();
		    if(selectedItem.activeCSS)
		    {
		    	util.removeStyleClass(selectedItem.scroller,selectedItem.activeCSS);
		    }
		    selection(true);
		    selectedItem.dragging = false;
		    updateScrollBars();
		    selectedItem = null;
		    clearScroll();
		};
		
		var scrollBody = function(item,event)
		{
			updateScrollPositions(item,false);
		};
		
		var dragHandler = function(item,event)
		{
			 var rel = barPositionToRelative(item,getCursorPosition(item,event) - item.scrollerPos);
			 var sub = config.scrollableElement[item.scrollSize] - config.scrollableElement[item.client];
			 setScrollableItems(item,rel * sub);
		};
		
		var setScrollableItems = function(item,scrollPos)
		{
			config.scrollableElement[item.scroll] = scrollPos;
			if(config.otherScrollableElement && config.otherScrollableElement.length > 0)
			{
				for(var count = 0;count < config.otherScrollableElement.length;count++)
				{
					var element = config.otherScrollableElement[count];
					element[item.scroll] = scrollPos;
				}
			}
		};
		
		var getCursorPosition = function(item,event)
		{
	    	return event["client" + item.x] || ((event.touches || {})[0] || {})["page" + item.x];
		};
		
		var updateScrollBars =  function()
		{
			for(var key in props)
			{
				var item = props[key];
				applyStyle(item,true);
				resizeHandler(item);
				updateScrollPositions(item,true);
			}
			updateScrollControls();
		};
		
		var resizeHandler = function(item)
		{
			var updatePos = function()
			{
				 var offset = config.scrollableElement[item.crossOffset];
	             var client = config.scrollableElement[item.crossClient];
	             var padding = 0;
	             var oldPos, newPos;
	             if (isMacFF) 
	             {
	             	padding = macScrollBarSize;
	             }
	             else if (client > 0 && offset === 0) 
	             {
	             	offset = client + operaMaxScrollBarSize;
	             }
	             if (offset) 
	             {
	            	 var delta = offset - client + padding;
	            	 if (item.elementPosition == 'static') 
	            	 {
	                     oldPos = util.css(config.scrollableElement,item.crossSize);
	                     newPos = parentNode[item.crossClient] + delta + 'px';
	                     if (oldPos != newPos) 
	                     {
	                         setCrossSizes(item,config.scrollableElement, newPos);
	                     }
	                 } 
	            	 else
	            	 {
	            		 var styles = {};
	                     var key = item.rtl ? 'Left' : 'Right';
	                     if (item.direction == 'h') 
	                     {
	                         key = 'Bottom';
	                     }
	                     util.css(config.scrollableElement, styles);
	            	 }
	            	 
	             }
	             item.resizeLastFire = getCurrentTime();
			};
			var container = item["container"];
			var scroller = item["scroller"];
			var scrollerSize =  item["scrollerSize"];
			var barPos = item["barPos"];
			var minPeriod = (item.resizeDebounce === undefined) ? 300 : item.resizeDebounce;
		   	var delay = 0;
		   	if (getCurrentTime() - item.resizeLastFire < minPeriod) 
		   	{
	            clearTimeout(item.resizePauseTimer);
	            delay = minPeriod;
	        }
		   	if (delay) 
		   	{
		   		item.resizePauseTimer = setTimeout(updatePos, delay);
	        } 
		   	else 
		   	{
		   		updatePos();
	        }
		};
		
		var addObserver = function()
		{
			var mutationProp = { attributes: false, childList: true, subtree: true};
			var callback = function(mutationsList, observer) 
			{
				for(var count = 0;count < mutationsList.length;count++)
			    {
			    	var mutation = mutationsList[count];
			        if (mutation.type == 'childList') 
			        {
			        	updateWithDelay();
			        }
			    }
			};
			var mutationObserver = new MutationObserver(callback);
			mutationObserver.observe(config.scrollableElement,mutationProp);
		};
		
		var updateWithDelay = function()
		{
			stopDelayInterval();
			delayInterval = setInterval(function() {
				updateScrollBars();
				stopDelayInterval();
	        }, 300); 
		};
		
		var stopDelayInterval = function()
		{
			if(delayInterval)
			{
				clearInterval(delayInterval);
				delayInterval = null;
			}
		};
		
		var setCrossSizes = function(item,element,size) 
		{
	        var styles = {};
	        styles[item.crossSize] = size;
	        styles[item.crossMinSize] = size;
	        styles[item.crossMaxSize] = size;
	        util.css(element, styles);
	    };
		
		var getCurrentTime = function()
		{
			 return new Date().getTime();
		};
		
		var updateScrollPositions = function(item,isReset)
		{
			checkScroll(item);
			var container = item["container"];
			var scroller = item["scroller"];
			var scrollerSize =  item["scrollerSize"];
			var barPos = item["barPos"];
			var newBarSize = (container[item.client] - item.barTopLimit) *
			config.scrollableElement[item.client] / config.scrollableElement[item.scrollSize];
	        // Positioning bar
	        if (isReset || parseInt(scrollerSize, 10) != parseInt(newBarSize, 10)) 
	        {
	            setScrollerSize(item,newBarSize);
	            item["scrollerSize"] = newBarSize;
	        }
	        item["barPos"] = relativeToBarPosition(item,relativePosition(item));
	        setBarPosition(item, item["barPos"]);
		};
		
		var setBarPosition = function(item,position)
		{
			var scroller = item["scroller"];
			var oldPos = scroller.style[item.pos];
	        var newPos = position + "px";
	
	        if (newPos && newPos != oldPos) 
	        {
	        	scroller.style[item.pos] = newPos;
	        }
		};
		
		var setScrollerSize = function(item,size) 
		{
			var scroller = item["scroller"];
	    	var barMinSize = item.barMinSize || 20;
	    	var newSize = size;
	        if (newSize > 0 && newSize < barMinSize) 
	        {
	        	newSize = barMinSize;
	        }
	        if(scroller) 
	        {
	        	scroller.style[item.size] = parseInt(newSize, 10) + "px";
	        }
	    };
	    
	    var relativePosition = function(item,position)
	    {
	    	var size = config.scrollableElement[item.scrollSize] - config.scrollableElement[item.client];
	        var newPos;
	        if(position) 
	        {
	        	newPos = scrollableElementPosition(item,position * size);
	        } 
	        else 
	        {
	        	newPos = scrollableElementPosition(item);
	        }
	        return newPos / (size || 1);
	    };
	    
	    var scrollableElementPosition = function(item,x) 
	    { 
	        var ie = "page" + item.x + "Offset";
	        var key = (config.scrollableElement[ie]) ? ie : item.scroll;
	        if (!util.isUndefined(x)) 
	        {
	        	if(key === item.scroll)
	        	{
	        		setScrollableItems(item,x);
	        	}
	        	else
	        	{
	        		config.scrollableElement[key] = x;
	        	}
	        }
	        return config.scrollableElement[key];
	    };
	    
	    var relativeToBarPosition = function(item,pos) 
	    {
	        return pos * getPos(item) + item.barTopLimit;
	    };
	    
	    var barPositionToRelative = function(item,pos) 
	    {
	        return (pos - item.barTopLimit) / getPos(item);
	    };
	    
	    var getPos = function(item)
	    {
	    	return item.container[item.client] - item.barTopLimit - item.scroller[item.offset];
	    };
		
		var addDocumentHandler = function(moveHandler,endHandler)
		{
			if(!documentMouseMoveRef)
			{
				documentMouseMoveRef = moveHandler;
				util.addEvent(document.documentElement,"mousemove",documentMouseMoveRef);
				
			}
			if(!documentMouseUpRef)
			{
				documentMouseUpRef = endHandler;
				util.addEvent(document.documentElement,"mouseup",documentMouseUpRef);
			}
			if(!documentTouchMoveRef)
			{
				documentTouchMoveRef = moveHandler;
				util.addEvent(document.documentElement,"touchmove",documentTouchMoveRef);
				
			}
			if(!documentTouchEndRef)
			{
				documentTouchEndRef = endHandler;
				util.addEvent(document.documentElement,"touchend",documentTouchEndRef);
			}
		};
		
		var removeDocumentHandler = function()
		{
			if(documentMouseMoveRef)
			{
				util.removeEvent(document.documentElement,"mousemove",documentMouseMoveRef);
				documentMouseMoveRef = null;
			}
			if(documentMouseUpRef)
			{
				util.removeEvent(document.documentElement,"mouseup",documentMouseUpRef);
				documentMouseUpRef = null;
			}
			if(documentTouchMoveRef)
			{
				util.removeEvent(document.documentElement,"touchmove",documentTouchMoveRef);
				documentTouchMoveRef = null;
			}
			if(documentTouchEndRef)
			{
				util.removeEvent(document.documentElement,"touchend",documentTouchEndRef);
				documentTouchEndRef = null;
			}
		};
		
		var checkScroll = function(item)
		{
			var scrollContainer = item["scrollContainer"];
			var scroller = item["scroller"];
			var isOverflowing = config.scrollableElement[item.client] < config.scrollableElement[item.scrollSize];
			if(isOverflowing)
			{
				util.addStyleClass(config.scrollableElement,"nsScrollerScrollable-" + item.direction);
				util.removeStyleClass(scrollContainer,"nsScrollerHidden");
			}
			else
			{
				util.removeStyleClass(config.scrollableElement,"nsScrollerScrollable-" + item.direction);
				util.addStyleClass(scrollContainer,"nsScrollerHidden");
			}
		};
		
		var updateScrollControls = function()
		{
			var scrollPresent = isBothScrollPresent();
			for(var key in props)
			{
				var item = props[key];
				var scrollContainer = item["scrollContainer"];
				var container = item["container"];
				var scroller = item["scroller"];
				if(scrollPresent)
				{
					util.addStyleClass(scrollContainer,item.containerCSS + "-both");
					util.addStyleClass(scrollContainer,"nsScrollerBarParent" + "-" + item.direction + "-both");
					if(item.buttonAfter)
					{
						util.addStyleClass(item.buttonAfter,item.afterButtonCSS + "-both");
					}
				}
				else
				{
					util.removeStyleClass(scrollContainer,item.containerCSS + "-both");
					util.removeStyleClass(scrollContainer,"nsScrollerBarParent" + "-" + item.direction + "-both");
					if(item.buttonAfter)
					{
						util.removeStyleClass(item.buttonAfter,item.afterButtonCSS + "-both");
					}
				}
			}
			if(scrollPresent)
			{
				util.removeStyleClass(divScrollBarCorner,"nsScrollerHidden");
			}
			else
			{
				util.addStyleClass(divScrollBarCorner,"nsScrollerHidden");
			}
		};
		
		var isBothScrollPresent = function()
		{
			var arrScrollContainer = config.element.querySelectorAll(".nsScrollerContainer");
			var retValue = true;
			for(var count = 0;count < arrScrollContainer.length;count++)
			{
				var scrollContainer = arrScrollContainer[count];
				if(util.hasStyleClass(scrollContainer,"nsScrollerHidden"))
				{
					retValue = false;
				}
			}
			return retValue;
		};
		
		var remove = function()
		{
			removeDocumentHandler();
			util.removeEvent(window,"resize",updateWithDelay);
			clearScroll();
			if(mutationObserver)
			{
				mutationObserver.disconnect();
			}
		};
		
		self.remove = remove;
		
		initialize();
	};
	
	return NSScroller;
})();
nsModuleExport(this,"NSScroller",NSScroller);
